"""
Reformat training data into a report export so that it can be imported into TRAM.

The target format is:
{
    "sentence-text": ["<technique-id-1>", "<technique-id-2>", "<technique-id-N>"]
}

The original format is:
    * negative_data.json - A file with sentences that have no mappings. This is a simple list of strings.
    * all_analyzed_reports.json - A file with mappings. Has the following structure:
    {
        "<attack-technique-description>": ["<sentence-1>", "<sentence-2>", "<sentence-n>"],  # OR
        "<description-1 description-2 description-N -multi>": {  # Can use key.endswith('-multi') to test
        "technique_names": [
                "description-1",
                "description-2",
                "description-N",
            ],
            "sentances": [  # Note the word sentences is misspelled as sentances
                "<sentence-1>",
                "<sentence-2>",
                "<sentence-N>"
            ]
        }
    }

The target format is defined by tram.serializers.ReportExportSerializer
"""

import itertools
import json
import logging
import os
import sys
from datetime import datetime
from functools import partial

import django

sys.path.append("/Users/ankitchauhan/Drive/tram/src/")
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "tram.settings")
django.setup()

from tram.serializers import ReportExportSerializer  # noqa: E402

outfile = "/Users/ankitchauhan/Drive/tram/data/training/bootstrap-training-data.json"
logger = logging.getLogger(__name__)


# ATTACK_LOOKUP = {  # A mapping of attack descriptions to technique IDs
#     "drive-by compromise": "T1189",
#     "system information discovery": "T1082",
#     "new service": "T1543",
#     "service execution": "T1569.002",
#     "command-line interface": "T1059",  # Maps to: T1059 - Command and Scripting Interpreter
#     "obfuscated files or information": "T1027",
#     "custom cryptographic protocol": "T1573",  # Maps to: T1573 - Encrypted Channel
#     "system network configuration discovery": "T1016",
#     "web shell": "T1505.003",
#     "application window discovery": "T1010",
#     "file deletion": "T1070.004",  # Technique that became a subtechnique
#     "standard application layer protocol": "T1071",
#     "web service": "T1102",
#     "exfiltration over command and control channel": "T1041",
#     "fallback channels": "T1008",
#     "bypass user account control": "T1548.002",  # Technique that became a subtechnique
#     "system time discovery": "T1124",
#     "deobfuscate/decode files or information": "T1140",
#     "disabling security tools": "T1562.001",  # Maps to: T1562.001 - Impair Defenses: Disable or Modify Tools
#     "registry run keys / startup folder": "T1547.001",
#     "remote file copy": "T1105",  # Maps to: T1105 - Ingress Tool Transfer
#     "dll search order hijacking": "T1574.001",
#     "screen capture": "T1113",
#     "file and directory discovery": "T1083",
#     "tor": "S0183",  # Software??
#     "shortcut modification": "T1547.009",
#     "remote services": "T1021",
#     "connection proxy": "T1090",
#     "data encoding": "T1132",
#     "spearphishing link": "T1566.002",
#     "spearphishing attachment": "T1566.001",
#     "arp": "S0099",
#     "user execution": "T1204",
#     "process hollowing": "T1055.012",
#     "execution through api": "T1106",  # Maps to T1106 - Native API
#     "masquerading": "T1036",
#     "code signing": "T1553.002",
#     "standard cryptographic protocol": "T1521",
#     "scripting": "T1059",
#     "remote system discovery": "T1018",
#     "credential dumping": "T1003",
#     "exploitation for client execution": "T1203",
#     "exploitation for privilege escalation": "T1068",
#     "security software discovery": "T1518.001",
#     "data from local system": "T1533",
#     "remote desktop protocol": "T1021.001",
#     "data compressed": "T1560",  # Maps to T1560 - Archive Collected Data
#     "software packing": "T1027.002",
#     "ping": "S0097",
#     "brute force": "T1110",
#     "commonly used port": "T1571",
#     "modify registry": "T1112",
#     "uncommonly used port": "T1571",
#     "process injection": "T1055",
#     "timestomp": "T1070.006",
#     "windows management instrumentation": "T1047",
#     "data staged": "T1074",
#     "rundll32": "T1218.011",
#     "regsvr32": "T1218.010",
#     "account discovery": "T1087",
#     "process discovery": "T1057",
#     "clipboard data": "T1115",
#     "binary padding": "T1027.001",
#     "pass the hash": "T1550.002",
#     "network service scanning": "T1046",
#     "system service discovery": "T1007",
#     "data encrypted": "T1486",
#     "system network connections discovery": "T1049",
#     "windows admin shares": "T1021.002",
#     "system owner/user discovery": "T1033",
#     "launch agent": "T1543.001",
#     "permission groups discovery": "T1069",
#     "indicator removal on host": "T1070",
#     "input capture": "T1056",
#     "virtualization/sandbox evasion": "T1497.001",
#     "dll side-loading": "T1574.002",
#     "scheduled task": "T1053",
#     "access token manipulation": "T1134",
#     "powershell": "T1546.013",
#     "exfiltration over alternative protocol": "T1048",
#     "hidden files and directories": "T1564.001",
#     "network share discovery": "T1135",
#     "query registry": "T1012",
#     "credentials in files": "T1552.001",
#     "audio capture": "T1123",
#     "video capture": "T1125",
#     "peripheral device discovery": "T1120",
#     "spearphishing via service": "T1566.003",
#     "data encrypted for impact": "T1486",
#     "data destruction": "T1485",
#     "template injection": "T1221",
#     "inhibit system recovery": "T1490",
#     "create account": "T1136",
#     "exploitation of remote services": "T1210",
#     "valid accounts": "T1078",
#     "dynamic data exchange": "T1559.002",
#     "office application startup": "T1137",
#     "data obfuscation": "T1001",
#     "domain trust discovery": "T1482",
#     "email collection": "T1114",
#     "man in the browser": "T1185",
#     "data from removable media": "T1025",
#     "bootkit": "T1542.003",
#     "logon scripts": "T1037",
#     "execution through module load": "T1129",
#     "llmnr/nbt-ns poisoning and relay": "T1557.001",
#     "external remote services": "T1133",
#     "domain fronting": "T1090.004",
#     "sid-history injection": "T1134.005",
#     "service stop": "T1489",
#     "disk structure wipe": "T1561.002",
#     "credentials in registry": "T1552.002",
#     "appinit dlls": "T1546.010",
#     "exploit public-facing application": "T1190",
#     "remote access tools": "T1219",
#     "signed binary proxy execution": "T1218",
#     "appcert dlls": "T1546.009",
#     "winlogon helper dll": "T1547.004",
#     "file permissions modification": "T1222",
#     "hooking": "T1056.004",
#     "system firmware": "T1542.001",
#     "lsass driver": "T1547.008",
#     "distributed component object model": "T1021.003",
#     "cmstp": "T1218.003",
#     "execution guardrails": "T1480",
#     "component object model hijacking": "T1546.015",
#     "accessibility features": "T1546.008",  # TODO: Help wanted
#     "keychain": "T1555.001",
#     "mshta": "T1218.005",
#     "pass the ticket": "T1550.003",
#     "kerberoasting": "T1558.003",
#     "password policy discovery": "T1201",
#     "local job scheduling": "T1053.001",
#     "windows remote management": "T1021.006",
#     "bits jobs": "T1197",
#     "data from information repositories": "T1213",
#     "lc_load_dylib addition": "T1546.006",
#     "histcontrol": "T1562.003",
#     "file system logical offsets": "T1006",
#     "regsvcs/regasm": "T1218.009",
#     "exploitation for credential access": "T1212",
#     "sudo": "T1548.003",
#     "installutil": "T1218.004",
#     "query registry ": "T1012",
#     "launchctl": "T1569.001",
#     ".bash_profile and .bashrc": "T1546.004",
#     "applescript": "T1059.002",
#     "emond": "T1546.014",
#     "control panel items": "T1218.002",
#     "application shimming": "T1546.011",
# }

ATTACK_LOOKUP = {
    "data obfuscation": "T1001",
    "junk data": "T1001.001",
    "steganography": "T1001.002",
    "protocol impersonation": "T1001.003",
    "os credential dumping": "T1003",
    "lsass memory": "T1003.001",
    "security account manager": "T1003.002",
    "ntds": "T1003.003",
    "lsa secrets": "T1003.004",
    "cached domain credentials": "T1003.005",
    "dcsync": "T1003.006",
    "proc filesystem": "T1003.007",
    "/etc/passwd and /etc/shadow": "T1003.008",
    "data from local system": "T1005",
    "direct volume access": "T1006",
    "system service discovery": "T1007",
    "fallback channels": "T1008",
    "application window discovery": "T1010",
    "exfiltration over other network medium": "T1011",
    "exfiltration over bluetooth": "T1011.001",
    "query registry": "T1012",
    "rootkit": "T1014",
    "system network configuration discovery": "T1016",
    "internet connection discovery": "T1016.001",
    "remote system discovery": "T1018",
    "automated exfiltration": "T1020",
    "traffic duplication": "T1020.001",
    "remote services": "T1021",
    "remote desktop protocol": "T1021.001",
    "smb/windows admin shares": "T1021.002",
    "distributed component object model": "T1021.003",
    "ssh": "T1021.004",
    "vnc": "T1021.005",
    "windows remote management": "T1021.006",
    "data from removable media": "T1025",
    "obfuscated files or information": "T1027",
    "binary padding": "T1027.001",
    "software packing": "T1027.002",
    "steganography": "T1027.003",
    "compile after delivery": "T1027.004",
    "indicator removal from tools": "T1027.005",
    "html smuggling": "T1027.006",
    "scheduled transfer": "T1029",
    "data transfer size limits": "T1030",
    "system owner/user discovery": "T1033",
    "masquerading": "T1036",
    "invalid code signature": "T1036.001",
    "right-to-left override": "T1036.002",
    "rename system utilities": "T1036.003",
    "masquerade task or service": "T1036.004",
    "match legitimate name or location": "T1036.005",
    "space after filename": "T1036.006",
    "double file extension": "T1036.007",
    "boot or logon initialization scripts": "T1037",
    "logon script (windows)": "T1037.001",
    "login hook": "T1037.002",
    "network logon script": "T1037.003",
    "rc scripts": "T1037.004",
    "startup items": "T1037.005",
    "data from network shared drive": "T1039",
    "network sniffing": "T1040",
    "exfiltration over c2 channel": "T1041",
    "network service discovery": "T1046",
    "windows management instrumentation": "T1047",
    "exfiltration over alternative protocol": "T1048",
    "exfiltration over symmetric encrypted non-c2 protocol": "T1048.001",
    "exfiltration over asymmetric encrypted non-c2 protocol": "T1048.002",
    "exfiltration over unencrypted non-c2 protocol": "T1048.003",
    "system network connections discovery": "T1049",
    "exfiltration over physical medium": "T1052",
    "exfiltration over usb": "T1052.001",
    "scheduled task/job": "T1053",
    "at": "T1053.002",
    "cron": "T1053.003",
    "scheduled task": "T1053.005",
    "systemd timers": "T1053.006",
    "container orchestration job": "T1053.007",
    "process injection": "T1055",
    "dynamic-link library injection": "T1055.001",
    "portable executable injection": "T1055.002",
    "thread execution hijacking": "T1055.003",
    "asynchronous procedure call": "T1055.004",
    "thread local storage": "T1055.005",
    "ptrace system calls": "T1055.008",
    "proc memory": "T1055.009",
    "extra window memory injection": "T1055.011",
    "process hollowing": "T1055.012",
    "process doppelg√§nging": "T1055.013",
    "vdso hijacking": "T1055.014",
    "listplanting": "T1055.015",
    "input capture": "T1056",
    "keylogging": "T1056.001",
    "gui input capture": "T1056.002",
    "web portal capture": "T1056.003",
    "credential api hooking": "T1056.004",
    "process discovery": "T1057",
    "command and scripting interpreter": "T1059",
    "powershell": "T1059.001",
    "applescript": "T1059.002",
    "windows command shell": "T1059.003",
    "unix shell": "T1059.004",
    "visual basic": "T1059.005",
    "python": "T1059.006",
    "javascript": "T1059.007",
    "network device cli": "T1059.008",
    "exploitation for privilege escalation": "T1068",
    "permission groups discovery": "T1069",
    "local groups": "T1069.001",
    "domain groups": "T1069.002",
    "cloud groups": "T1069.003",
    "indicator removal on host": "T1070",
    "clear windows event logs": "T1070.001",
    "clear linux or mac system logs": "T1070.002",
    "clear command history": "T1070.003",
    "file deletion": "T1070.004",
    "network share connection removal": "T1070.005",
    "timestomp": "T1070.006",
    "application layer protocol": "T1071",
    "web protocols": "T1071.001",
    "file transfer protocols": "T1071.002",
    "mail protocols": "T1071.003",
    "dns": "T1071.004",
    "software deployment tools": "T1072",
    "data staged": "T1074",
    "local data staging": "T1074.001",
    "remote data staging": "T1074.002",
    "valid accounts": "T1078",
    "default accounts": "T1078.001",
    "domain accounts": "T1078.002",
    "local accounts": "T1078.003",
    "cloud accounts": "T1078.004",
    "taint shared content": "T1080",
    "system information discovery": "T1082",
    "file and directory discovery": "T1083",
    "account discovery": "T1087",
    "local account": "T1087.001",
    "domain account": "T1087.002",
    "email account": "T1087.003",
    "cloud account": "T1087.004",
    "proxy": "T1090",
    "internal proxy": "T1090.001",
    "external proxy": "T1090.002",
    "multi-hop proxy": "T1090.003",
    "domain fronting": "T1090.004",
    "replication through removable media": "T1091",
    "communication through removable media": "T1092",
    "non-application layer protocol": "T1095",
    "account manipulation": "T1098",
    "additional cloud credentials": "T1098.001",
    "additional email delegate permissions": "T1098.002",
    "additional cloud roles": "T1098.003",
    "ssh authorized keys": "T1098.004",
    "device registration": "T1098.005",
    "web service": "T1102",
    "dead drop resolver": "T1102.001",
    "bidirectional communication": "T1102.002",
    "one-way communication": "T1102.003",
    "multi-stage channels": "T1104",
    "ingress tool transfer": "T1105",
    "native api": "T1106",
    "brute force": "T1110",
    "password guessing": "T1110.001",
    "password cracking": "T1110.002",
    "password spraying": "T1110.003",
    "credential stuffing": "T1110.004",
    "multi-factor authentication interception": "T1111",
    "modify registry": "T1112",
    "screen capture": "T1113",
    "email collection": "T1114",
    "local email collection": "T1114.001",
    "remote email collection": "T1114.002",
    "email forwarding rule": "T1114.003",
    "clipboard data": "T1115",
    "automated collection": "T1119",
    "peripheral device discovery": "T1120",
    "audio capture": "T1123",
    "system time discovery": "T1124",
    "video capture": "T1125",
    "trusted developer utilities proxy execution": "T1127",
    "msbuild": "T1127.001",
    "shared modules": "T1129",
    "data encoding": "T1132",
    "standard encoding": "T1132.001",
    "non-standard encoding": "T1132.002",
    "external remote services": "T1133",
    "access token manipulation": "T1134",
    "token impersonation/theft": "T1134.001",
    "create process with token": "T1134.002",
    "make and impersonate token": "T1134.003",
    "parent pid spoofing": "T1134.004",
    "sid-history injection": "T1134.005",
    "network share discovery": "T1135",
    "create account": "T1136",
    "local account": "T1136.001",
    "domain account": "T1136.002",
    "cloud account": "T1136.003",
    "office application startup": "T1137",
    "office template macros": "T1137.001",
    "office test": "T1137.002",
    "outlook forms": "T1137.003",
    "outlook home page": "T1137.004",
    "outlook rules": "T1137.005",
    "add-ins": "T1137.006",
    "deobfuscate/decode files or information": "T1140",
    "browser extensions": "T1176",
    "browser session hijacking": "T1185",
    "forced authentication": "T1187",
    "drive-by compromise": "T1189",
    "exploit public-facing application": "T1190",
    "supply chain compromise": "T1195",
    "compromise software dependencies and development tools": "T1195.001",
    "compromise software supply chain": "T1195.002",
    "compromise hardware supply chain": "T1195.003",
    "bits jobs": "T1197",
    "trusted relationship": "T1199",
    "hardware additions": "T1200",
    "password policy discovery": "T1201",
    "indirect command execution": "T1202",
    "exploitation for client execution": "T1203",
    "user execution": "T1204",
    "malicious link": "T1204.001",
    "malicious file": "T1204.002",
    "malicious image": "T1204.003",
    "traffic signaling": "T1205",
    "port knocking": "T1205.001",
    "rogue domain controller": "T1207",
    "exploitation of remote services": "T1210",
    "exploitation for defense evasion": "T1211",
    "exploitation for credential access": "T1212",
    "data from information repositories": "T1213",
    "confluence": "T1213.001",
    "sharepoint": "T1213.002",
    "code repositories": "T1213.003",
    "system script proxy execution": "T1216",
    "pubprn": "T1216.001",
    "browser bookmark discovery": "T1217",
    "system binary proxy execution": "T1218",
    "compiled html file": "T1218.001",
    "control panel": "T1218.002",
    "cmstp": "T1218.003",
    "installutil": "T1218.004",
    "mshta": "T1218.005",
    "msiexec": "T1218.007",
    "odbcconf": "T1218.008",
    "regsvcs/regasm": "T1218.009",
    "regsvr32": "T1218.010",
    "rundll32": "T1218.011",
    "verclsid": "T1218.012",
    "mavinject": "T1218.013",
    "mmc": "T1218.014",
    "remote access software": "T1219",
    "xsl script processing": "T1220",
    "template injection": "T1221",
    "file and directory permissions modification": "T1222",
    "windows file and directory permissions modification": "T1222.001",
    "linux and mac file and directory permissions modification": "T1222.002",
    "execution guardrails": "T1480",
    "environmental keying": "T1480.001",
    "domain trust discovery": "T1482",
    "domain policy modification": "T1484",
    "group policy modification": "T1484.001",
    "domain trust modification": "T1484.002",
    "data destruction": "T1485",
    "data encrypted for impact": "T1486",
    "service stop": "T1489",
    "inhibit system recovery": "T1490",
    "defacement": "T1491",
    "internal defacement": "T1491.001",
    "external defacement": "T1491.002",
    "firmware corruption": "T1495",
    "resource hijacking": "T1496",
    "virtualization/sandbox evasion": "T1497",
    "system checks": "T1497.001",
    "user activity based checks": "T1497.002",
    "time based evasion": "T1497.003",
    "network denial of service": "T1498",
    "direct network flood": "T1498.001",
    "reflection amplification": "T1498.002",
    "endpoint denial of service": "T1499",
    "os exhaustion flood": "T1499.001",
    "service exhaustion flood": "T1499.002",
    "application exhaustion flood": "T1499.003",
    "application or system exploitation": "T1499.004",
    "server software component": "T1505",
    "sql stored procedures": "T1505.001",
    "transport agent": "T1505.002",
    "web shell": "T1505.003",
    "iis components": "T1505.004",
    "terminal services dll": "T1505.005",
    "software discovery": "T1518",
    "security software discovery": "T1518.001",
    "implant internal image": "T1525",
    "cloud service discovery": "T1526",
    "steal application access token": "T1528",
    "system shutdown/reboot": "T1529",
    "data from cloud storage object": "T1530",
    "account access removal": "T1531",
    "internal spearphishing": "T1534",
    "unused/unsupported cloud regions": "T1535",
    "transfer data to cloud account": "T1537",
    "cloud service dashboard": "T1538",
    "steal web session cookie": "T1539",
    "pre-os boot": "T1542",
    "system firmware": "T1542.001",
    "component firmware": "T1542.002",
    "bootkit": "T1542.003",
    "rommonkit": "T1542.004",
    "tftp boot": "T1542.005",
    "create or modify system process": "T1543",
    "launch agent": "T1543.001",
    "systemd service": "T1543.002",
    "windows service": "T1543.003",
    "launch daemon": "T1543.004",
    "event triggered execution": "T1546",
    "change default file association": "T1546.001",
    "screensaver": "T1546.002",
    "windows management instrumentation event subscription": "T1546.003",
    "unix shell configuration modification": "T1546.004",
    "trap": "T1546.005",
    "lc_load_dylib addition": "T1546.006",
    "netsh helper dll": "T1546.007",
    "accessibility features": "T1546.008",
    "appcert dlls": "T1546.009",
    "appinit dlls": "T1546.010",
    "application shimming": "T1546.011",
    "image file execution options injection": "T1546.012",
    "powershell profile": "T1546.013",
    "emond": "T1546.014",
    "component object model hijacking": "T1546.015",
    "boot or logon autostart execution": "T1547",
    "registry run keys / startup folder": "T1547.001",
    "authentication package": "T1547.002",
    "time providers": "T1547.003",
    "winlogon helper dll": "T1547.004",
    "security support provider": "T1547.005",
    "kernel modules and extensions": "T1547.006",
    "re-opened applications": "T1547.007",
    "lsass driver": "T1547.008",
    "shortcut modification": "T1547.009",
    "port monitors": "T1547.010",
    "print processors": "T1547.012",
    "xdg autostart entries": "T1547.013",
    "active setup": "T1547.014",
    "login items": "T1547.015",
    "abuse elevation control mechanism": "T1548",
    "setuid and setgid": "T1548.001",
    "bypass user account control": "T1548.002",
    "sudo and sudo caching": "T1548.003",
    "elevated execution with prompt": "T1548.004",
    "use alternate authentication material": "T1550",
    "application access token": "T1550.001",
    "pass the hash": "T1550.002",
    "pass the ticket": "T1550.003",
    "web session cookie": "T1550.004",
    "unsecured credentials": "T1552",
    "credentials in files": "T1552.001",
    "credentials in registry": "T1552.002",
    "bash history": "T1552.003",
    "private keys": "T1552.004",
    "cloud instance metadata api": "T1552.005",
    "group policy preferences": "T1552.006",
    "container api": "T1552.007",
    "subvert trust controls": "T1553",
    "gatekeeper bypass": "T1553.001",
    "code signing": "T1553.002",
    "sip and trust provider hijacking": "T1553.003",
    "install root certificate": "T1553.004",
    "mark-of-the-web bypass": "T1553.005",
    "code signing policy modification": "T1553.006",
    "compromise client software binary": "T1554",
    "credentials from password stores": "T1555",
    "keychain": "T1555.001",
    "securityd memory": "T1555.002",
    "credentials from web browsers": "T1555.003",
    "windows credential manager": "T1555.004",
    "password managers": "T1555.005",
    "modify authentication process": "T1556",
    "domain controller authentication": "T1556.001",
    "password filter dll": "T1556.002",
    "pluggable authentication modules": "T1556.003",
    "network device authentication": "T1556.004",
    "reversible encryption": "T1556.005",
    "adversary-in-the-middle": "T1557",
    "llmnr/nbt-ns poisoning and smb relay": "T1557.001",
    "arp cache poisoning": "T1557.002",
    "dhcp spoofing": "T1557.003",
    "steal or forge kerberos tickets": "T1558",
    "golden ticket": "T1558.001",
    "silver ticket": "T1558.002",
    "kerberoasting": "T1558.003",
    "as-rep roasting": "T1558.004",
    "inter-process communication": "T1559",
    "component object model": "T1559.001",
    "dynamic data exchange": "T1559.002",
    "xpc services": "T1559.003",
    "archive collected data": "T1560",
    "archive via utility": "T1560.001",
    "archive via library": "T1560.002",
    "archive via custom method": "T1560.003",
    "disk wipe": "T1561",
    "disk content wipe": "T1561.001",
    "disk structure wipe": "T1561.002",
    "impair defenses": "T1562",
    "disable or modify tools": "T1562.001",
    "disable windows event logging": "T1562.002",
    "impair command history logging": "T1562.003",
    "disable or modify system firewall": "T1562.004",
    "indicator blocking": "T1562.006",
    "disable or modify cloud firewall": "T1562.007",
    "disable cloud logs": "T1562.008",
    "safe mode boot": "T1562.009",
    "downgrade attack": "T1562.010",
    "remote service session hijacking": "T1563",
    "ssh hijacking": "T1563.001",
    "rdp hijacking": "T1563.002",
    "hide artifacts": "T1564",
    "hidden files and directories": "T1564.001",
    "hidden users": "T1564.002",
    "hidden window": "T1564.003",
    "ntfs file attributes": "T1564.004",
    "hidden file system": "T1564.005",
    "run virtual instance": "T1564.006",
    "vba stomping": "T1564.007",
    "email hiding rules": "T1564.008",
    "resource forking": "T1564.009",
    "process argument spoofing": "T1564.010",
    "data manipulation": "T1565",
    "stored data manipulation": "T1565.001",
    "transmitted data manipulation": "T1565.002",
    "runtime data manipulation": "T1565.003",
    "phishing": "T1566",
    "spearphishing attachment": "T1566.001",
    "spearphishing link": "T1566.002",
    "spearphishing via service": "T1566.003",
    "exfiltration over web service": "T1567",
    "exfiltration to code repository": "T1567.001",
    "exfiltration to cloud storage": "T1567.002",
    "dynamic resolution": "T1568",
    "fast flux dns": "T1568.001",
    "domain generation algorithms": "T1568.002",
    "dns calculation": "T1568.003",
    "system services": "T1569",
    "launchctl": "T1569.001",
    "service execution": "T1569.002",
    "lateral tool transfer": "T1570",
    "non-standard port": "T1571",
    "protocol tunneling": "T1572",
    "encrypted channel": "T1573",
    "symmetric cryptography": "T1573.001",
    "asymmetric cryptography": "T1573.002",
    "hijack execution flow": "T1574",
    "dll search order hijacking": "T1574.001",
    "dll side-loading": "T1574.002",
    "dylib hijacking": "T1574.004",
    "executable installer file permissions weakness": "T1574.005",
    "dynamic linker hijacking": "T1574.006",
    "path interception by path environment variable": "T1574.007",
    "path interception by search order hijacking": "T1574.008",
    "path interception by unquoted path": "T1574.009",
    "services file permissions weakness": "T1574.010",
    "services registry permissions weakness": "T1574.011",
    "cor_profiler": "T1574.012",
    "kernelcallbacktable": "T1574.013",
    "modify cloud compute infrastructure": "T1578",
    "create snapshot": "T1578.001",
    "create cloud instance": "T1578.002",
    "delete cloud instance": "T1578.003",
    "revert cloud instance": "T1578.004",
    "cloud infrastructure discovery": "T1580",
    "acquire infrastructure": "T1583",
    "domains": "T1583.001",
    "dns server": "T1583.002",
    "virtual private server": "T1583.003",
    "server": "T1583.004",
    "botnet": "T1583.005",
    "web services": "T1583.006",
    "compromise infrastructure": "T1584",
    "domains": "T1584.001",
    "dns server": "T1584.002",
    "virtual private server": "T1584.003",
    "server": "T1584.004",
    "botnet": "T1584.005",
    "web services": "T1584.006",
    "establish accounts": "T1585",
    "social media accounts": "T1585.001",
    "email accounts": "T1585.002",
    "compromise accounts": "T1586",
    "social media accounts": "T1586.001",
    "email accounts": "T1586.002",
    "develop capabilities": "T1587",
    "malware": "T1587.001",
    "code signing certificates": "T1587.002",
    "digital certificates": "T1587.003",
    "exploits": "T1587.004",
    "obtain capabilities": "T1588",
    "malware": "T1588.001",
    "tool": "T1588.002",
    "code signing certificates": "T1588.003",
    "digital certificates": "T1588.004",
    "exploits": "T1588.005",
    "vulnerabilities": "T1588.006",
    "gather victim identity information": "T1589",
    "credentials": "T1589.001",
    "email addresses": "T1589.002",
    "employee names": "T1589.003",
    "gather victim network information": "T1590",
    "domain properties": "T1590.001",
    "dns": "T1590.002",
    "network trust dependencies": "T1590.003",
    "network topology": "T1590.004",
    "ip addresses": "T1590.005",
    "network security appliances": "T1590.006",
    "gather victim org information": "T1591",
    "determine physical locations": "T1591.001",
    "business relationships": "T1591.002",
    "identify business tempo": "T1591.003",
    "identify roles": "T1591.004",
    "gather victim host information": "T1592",
    "hardware": "T1592.001",
    "software": "T1592.002",
    "firmware": "T1592.003",
    "client configurations": "T1592.004",
    "search open websites/domains": "T1593",
    "social media": "T1593.001",
    "search engines": "T1593.002",
    "search victim-owned websites": "T1594",
    "active scanning": "T1595",
    "scanning ip blocks": "T1595.001",
    "vulnerability scanning": "T1595.002",
    "wordlist scanning": "T1595.003",
    "search open technical databases": "T1596",
    "dns/passive dns": "T1596.001",
    "whois": "T1596.002",
    "digital certificates": "T1596.003",
    "cdns": "T1596.004",
    "scan databases": "T1596.005",
    "search closed sources": "T1597",
    "threat intel vendors": "T1597.001",
    "purchase technical data": "T1597.002",
    "phishing for information": "T1598",
    "spearphishing service": "T1598.001",
    "spearphishing attachment": "T1598.002",
    "spearphishing link": "T1598.003",
    "network boundary bridging": "T1599",
    "network address translation traversal": "T1599.001",
    "weaken encryption": "T1600",
    "reduce key space": "T1600.001",
    "disable crypto hardware": "T1600.002",
    "modify system image": "T1601",
    "patch system image": "T1601.001",
    "downgrade system image": "T1601.002",
    "data from configuration repository": "T1602",
    "snmp (mib dump)": "T1602.001",
    "network device configuration dump": "T1602.002",
    "forge web credentials": "T1606",
    "web cookies": "T1606.001",
    "saml tokens": "T1606.002",
    "stage capabilities": "T1608",
    "upload malware": "T1608.001",
    "upload tool": "T1608.002",
    "install digital certificate": "T1608.003",
    "drive-by target": "T1608.004",
    "link target": "T1608.005",
    "container administration command": "T1609",
    "deploy container": "T1610",
    "escape to host": "T1611",
    "build image on host": "T1612",
    "container and resource discovery": "T1613",
    "system location discovery": "T1614",
    "system language discovery": "T1614.001",
    "group policy discovery": "T1615",
    "cloud storage object discovery": "T1619",
    "reflective code loading": "T1620",
    "multi-factor authentication request generation": "T1621",
    "debugger evasion": "T1622",
    "plist file modification": "T1647",
    "standard cryptographic protocol": "T1521",
    "data from local system": "T1533",
}


class TrainingData(object):
    def __init__(self):
        self.mappings = {}  # Mapping is sentence text plus a list of Attack IDs

    def add_mapping(self, sentence_text, attack_id=None):
        mappings = self.mappings.get(sentence_text, [])  # Get mappings or empty list

        if attack_id:  # If attack_id is specified, add it to the list
            if attack_id not in mappings:
                mappings.append(attack_id)

        self.mappings[sentence_text] = mappings  # Put the mapping list back in

    def to_report_export_serializer_json(self):
        """Creates a dict that can be used to create
        a serializers.ReportExportSerializer instance
        """
        utc_now = datetime.utcnow().isoformat() + "Z"
        res_json = {
            "name": "Bootstrap Training Data",
            "text": "There is no text for this report. These sentences were mapped by human analysts.",
            "ml_model": "humans",
            "created_on": utc_now,
            "updated_on": utc_now,
            "sentences": [],
        }

        order = 0
        for sentence_text, mappings in self.mappings.items():
            if len(sentence_text.strip()) == 0:  # Skip empty sentences
                continue

            is_present = is_present_in_existing_database(sentence_text)

            sentence = {
                "text": sentence_text,
                "order": order,
                "disposition": "accept",
                "mappings": [],
            }

            order += 1

            for mapping in mappings:
                if is_present_in_existing_database(sentence_text):
                    mapping = {"attack_id": mapping, "confidence": "10.0"}
                else:
                    mapping = {"attack_id": mapping, "confidence": "100.0"}
                sentence["mappings"].append(mapping)
            res_json["sentences"].append(sentence)

        return res_json


def get_attack_id(description):
    """Given a description, get the ATTACK ID. Raises IndexError if the retrieval fails."""
    lower_description = description.lower()
    attack_id = ATTACK_LOOKUP[lower_description]
    # attack_id = ATTACK_LOOKUP[description]
    return attack_id


def is_present_in_existing_database(line):
    f = open(
        "/Users/ankitchauhan/Drive/tram/data/training/archive/tram_existing_dataset_.txt",
        "r",
    )
    existing_data = f.readlines()
    # existing_data = list(set(existing_data))
    if line + "\n" in existing_data:
        return True
    else:
        return False


def main():
    with open(
        "/Users/ankitchauhan/Drive/tram/data/training/archive/all_analyzed_reports.json",
        encoding="utf-8-sig",
    ) as f:
        all_analyzed_reports = json.load(f)

    with open(
        "/Users/ankitchauhan/Drive/tram/data/training/archive/negative_data.json"
    ) as f:
        negative_data = json.load(f)

    training_data = TrainingData()

    # Add the positives
    for key, value in all_analyzed_reports.items():
        if key.endswith("-multi"):  # It's a multi-mapping, value is a dictionary
            for sentence in value[
                "sentances"
            ]:  # Sentences is misspelled in the source data
                map(
                    partial(training_data.add_mapping, sentence),
                    [ATTACK_LOOKUP[name.lower()] for name in value["technique_names"]],
                )
        else:  # It's a single-mapping, value is a list of sentences
            technique_id = get_attack_id(key)
            for sentence in value:
                training_data.add_mapping(sentence, technique_id)

    # Add the negatives
    for sentence in negative_data:
        training_data.add_mapping(sentence, None)
    res_json = training_data.to_report_export_serializer_json()

    res = ReportExportSerializer(data=res_json)
    res.is_valid(raise_exception=True)

    with open(outfile, "w") as f:
        json.dump(res.initial_data, f, indent=4)

    logger.info("Wrote data to %s" % outfile)


if __name__ == "__main__":
    main()
