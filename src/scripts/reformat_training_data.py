"""
Reformat training data into a report export so that it can be imported into TRAM.

The target format is:
{
    "sentence-text": ["<technique-id-1>", "<technique-id-2>", "<technique-id-N>"]
}

The original format is:
    * negative_data.json - A file with sentences that have no mappings. This is a simple list of strings.
    * all_analyzed_reports.json - A file with mappings. Has the following structure:
    {
        "<attack-technique-description>": ["<sentence-1>", "<sentence-2>", "<sentence-n>"],  # OR
        "<description-1 description-2 description-N -multi>": {  # Can use key.endswith('-multi') to test
        "technique_names": [
                "description-1",
                "description-2",
                "description-N",
            ],
            "sentances": [  # Note the word sentences is misspelled as sentances
                "<sentence-1>",
                "<sentence-2>",
                "<sentence-N>"
            ]
        }
    }

The target format is defined by tram.serializers.ReportExportSerializer
"""

import json
import logging
import os
import sys
import string
from datetime import datetime
from functools import partial

import django

sys.path.append("src/")
os.environ.setdefault("DJANGO_SETTINGS_MODULE", "tram.settings")
django.setup()

from tram.serializers import ReportExportSerializer  # noqa: E402

outfile = "data/training/bootstrap-training-data.json"
logger = logging.getLogger(__name__)


# ATTACK_LOOKUP = {  # A mapping of attack descriptions to technique IDs
#     "drive-by compromise": "T1189",
#     "system information discovery": "T1082",
#     "new service": "T1543",
#     "service execution": "T1569.002",
#     "command-line interface": "T1059",  # Maps to: T1059 - Command and Scripting Interpreter
#     "obfuscated files or information": "T1027",
#     "custom cryptographic protocol": "T1573",  # Maps to: T1573 - Encrypted Channel
#     "system network configuration discovery": "T1016",
#     "web shell": "T1505.003",
#     "application window discovery": "T1010",
#     "file deletion": "T1070.004",  # Technique that became a subtechnique
#     "standard application layer protocol": "T1071",
#     "web service": "T1102",
#     "exfiltration over command and control channel": "T1041",
#     "fallback channels": "T1008",
#     "bypass user account control": "T1548.002",  # Technique that became a subtechnique
#     "system time discovery": "T1124",
#     "deobfuscate/decode files or information": "T1140",
#     "disabling security tools": "T1562.001",  # Maps to: T1562.001 - Impair Defenses: Disable or Modify Tools
#     "registry run keys / startup folder": "T1547.001",
#     "remote file copy": "T1105",  # Maps to: T1105 - Ingress Tool Transfer
#     "dll search order hijacking": "T1574.001",
#     "screen capture": "T1113",
#     "file and directory discovery": "T1083",
#     "tor": "S0183",  # Software??
#     "shortcut modification": "T1547.009",
#     "remote services": "T1021",
#     "connection proxy": "T1090",
#     "data encoding": "T1132",
#     "spearphishing link": "T1566.002",
#     "spearphishing attachment": "T1566.001",
#     "arp": "S0099",
#     "user execution": "T1204",
#     "process hollowing": "T1055.012",
#     "execution through api": "T1106",  # Maps to T1106 - Native API
#     "masquerading": "T1036",
#     "code signing": "T1553.002",
#     "standard cryptographic protocol": "T1521",
#     "scripting": "T1059",
#     "remote system discovery": "T1018",
#     "credential dumping": "T1003",
#     "exploitation for client execution": "T1203",
#     "exploitation for privilege escalation": "T1068",
#     "security software discovery": "T1518.001",
#     "data from local system": "T1533",
#     "remote desktop protocol": "T1021.001",
#     "data compressed": "T1560",  # Maps to T1560 - Archive Collected Data
#     "software packing": "T1027.002",
#     "ping": "S0097",
#     "brute force": "T1110",
#     "commonly used port": "T1571",
#     "modify registry": "T1112",
#     "uncommonly used port": "T1571",
#     "process injection": "T1055",
#     "timestomp": "T1070.006",
#     "windows management instrumentation": "T1047",
#     "data staged": "T1074",
#     "rundll32": "T1218.011",
#     "regsvr32": "T1218.010",
#     "account discovery": "T1087",
#     "process discovery": "T1057",
#     "clipboard data": "T1115",
#     "binary padding": "T1027.001",
#     "pass the hash": "T1550.002",
#     "network service scanning": "T1046",
#     "system service discovery": "T1007",
#     "data encrypted": "T1486",
#     "system network connections discovery": "T1049",
#     "windows admin shares": "T1021.002",
#     "system owner/user discovery": "T1033",
#     "launch agent": "T1543.001",
#     "permission groups discovery": "T1069",
#     "indicator removal on host": "T1070",
#     "input capture": "T1056",
#     "virtualization/sandbox evasion": "T1497.001",
#     "dll side-loading": "T1574.002",
#     "scheduled task": "T1053",
#     "access token manipulation": "T1134",
#     "powershell": "T1546.013",
#     "exfiltration over alternative protocol": "T1048",
#     "hidden files and directories": "T1564.001",
#     "network share discovery": "T1135",
#     "query registry": "T1012",
#     "credentials in files": "T1552.001",
#     "audio capture": "T1123",
#     "video capture": "T1125",
#     "peripheral device discovery": "T1120",
#     "spearphishing via service": "T1566.003",
#     "data encrypted for impact": "T1486",
#     "data destruction": "T1485",
#     "template injection": "T1221",
#     "inhibit system recovery": "T1490",
#     "create account": "T1136",
#     "exploitation of remote services": "T1210",
#     "valid accounts": "T1078",
#     "dynamic data exchange": "T1559.002",
#     "office application startup": "T1137",
#     "data obfuscation": "T1001",
#     "domain trust discovery": "T1482",
#     "email collection": "T1114",
#     "man in the browser": "T1185",
#     "data from removable media": "T1025",
#     "bootkit": "T1542.003",
#     "logon scripts": "T1037",
#     "execution through module load": "T1129",
#     "llmnr/nbt-ns poisoning and relay": "T1557.001",
#     "external remote services": "T1133",
#     "domain fronting": "T1090.004",
#     "sid-history injection": "T1134.005",
#     "service stop": "T1489",
#     "disk structure wipe": "T1561.002",
#     "credentials in registry": "T1552.002",
#     "appinit dlls": "T1546.010",
#     "exploit public-facing application": "T1190",
#     "remote access tools": "T1219",
#     "signed binary proxy execution": "T1218",
#     "appcert dlls": "T1546.009",
#     "winlogon helper dll": "T1547.004",
#     "file permissions modification": "T1222",
#     "hooking": "T1056.004",
#     "system firmware": "T1542.001",
#     "lsass driver": "T1547.008",
#     "distributed component object model": "T1021.003",
#     "cmstp": "T1218.003",
#     "execution guardrails": "T1480",
#     "component object model hijacking": "T1546.015",
#     "accessibility features": "T1546.008",  # TODO: Help wanted
#     "keychain": "T1555.001",
#     "mshta": "T1218.005",
#     "pass the ticket": "T1550.003",
#     "kerberoasting": "T1558.003",
#     "password policy discovery": "T1201",
#     "local job scheduling": "T1053.001",
#     "windows remote management": "T1021.006",
#     "bits jobs": "T1197",
#     "data from information repositories": "T1213",
#     "lc_load_dylib addition": "T1546.006",
#     "histcontrol": "T1562.003",
#     "file system logical offsets": "T1006",
#     "regsvcs/regasm": "T1218.009",
#     "exploitation for credential access": "T1212",
#     "sudo": "T1548.003",
#     "installutil": "T1218.004",
#     "query registry ": "T1012",
#     "launchctl": "T1569.001",
#     ".bash_profile and .bashrc": "T1546.004",
#     "applescript": "T1059.002",
#     "emond": "T1546.014",
#     "control panel items": "T1218.002",
#     "application shimming": "T1546.011",
#     "unsecured credentials":"T1552",
#     "replication through removable media":"T1091",
#     "develop capabilities: digital certificates":"T1587.003",
#     "obtain capabilities: digital certificates":"T1588.004",
#     "active scanning: vulnerability scanning":"T1595.002"
# }

ATTACK_LOOKUP={
    "T1189": "drive-by compromise",
    "T1082": "system information discovery",
    "T1543": "new service",
    "T1569.002": "service execution",
    "T1059": "scripting",
    "T1027": "obfuscated files or information",
    "T1573": "custom cryptographic protocol",
    "T1016": "system network configuration discovery",
    "T1505.003": "web shell",
    "T1010": "application window discovery",
    "T1070.004": "file deletion",
    "T1071": "standard application layer protocol",
    "T1102": "web service",
    "T1041": "exfiltration over command and control channel",
    "T1008": "fallback channels",
    "T1548.002": "bypass user account control",
    "T1124": "system time discovery",
    "T1140": "deobfuscate/decode files or information",
    "T1562.001": "disabling security tools",
    "T1547.001": "registry run keys / startup folder",
    "T1105": "remote file copy",
    "T1574.001": "dll search order hijacking",
    "T1113": "screen capture",
    "T1083": "file and directory discovery",
    "S0183": "tor",
    "T1547.009": "shortcut modification",
    "T1021": "remote services",
    "T1090": "connection proxy",
    "T1132": "data encoding",
    "T1566.002": "spearphishing link",
    "T1566.001": "spearphishing attachment",
    "S0099": "arp",
    "T1204": "user execution",
    "T1055.012": "process hollowing",
    "T1106": "execution through api",
    "T1036": "masquerading",
    "T1553.002": "code signing",
    "T1521": "standard cryptographic protocol",
    "T1018": "remote system discovery",
    "T1003": "credential dumping",
    "T1203": "exploitation for client execution",
    "T1068": "exploitation for privilege escalation",
    "T1518.001": "security software discovery",
    "T1533": "data from local system",
    "T1021.001": "remote desktop protocol",
    "T1560": "data compressed",
    "T1027.002": "software packing",
    "S0097": "ping",
    "T1110": "brute force",
    "T1571": "uncommonly used port",
    "T1112": "modify registry",
    "T1055": "process injection",
    "T1070.006": "timestomp",
    "T1047": "windows management instrumentation",
    "T1074": "data staged",
    "T1218.011": "rundll32",
    "T1218.010": "regsvr32",
    "T1087": "account discovery",
    "T1057": "process discovery",
    "T1115": "clipboard data",
    "T1027.001": "binary padding",
    "T1550.002": "pass the hash",
    "T1046": "network service scanning",
    "T1007": "system service discovery",
    "T1486": "data encrypted for impact",
    "T1049": "system network connections discovery",
    "T1021.002": "windows admin shares",
    "T1033": "system owner/user discovery",
    "T1543.001": "launch agent",
    "T1069": "permission groups discovery",
    "T1070": "indicator removal on host",
    "T1056": "input capture",
    "T1497.001": "virtualization/sandbox evasion",
    "T1574.002": "dll side-loading",
    "T1053": "scheduled task",
    "T1134": "access token manipulation",
    "T1546.013": "powershell",
    "T1048": "exfiltration over alternative protocol",
    "T1564.001": "hidden files and directories",
    "T1135": "network share discovery",
    "T1012": "query registry",
    "T1552.001": "credentials in files",
    "T1123": "audio capture",
    "T1125": "video capture",
    "T1120": "peripheral device discovery",
    "T1566.003": "spearphishing via service",
    "T1485": "data destruction",
    "T1221": "template injection",
    "T1490": "inhibit system recovery",
    "T1136": "create account",
    "T1210": "exploitation of remote services",
    "T1078": "valid accounts",
    "T1559.002": "dynamic data exchange",
    "T1137": "office application startup",
    "T1001": "data obfuscation",
    "T1482": "domain trust discovery",
    "T1114": "email collection",
    "T1185": "man in the browser",
    "T1025": "data from removable media",
    "T1542.003": "bootkit",
    "T1037": "logon scripts",
    "T1129": "execution through module load",
    "T1557.001": "llmnr/nbt-ns poisoning and relay",
    "T1133": "external remote services",
    "T1090.004": "domain fronting",
    "T1134.005": "sid-history injection",
    "T1489": "service stop",
    "T1561.002": "disk structure wipe",
    "T1552.002": "credentials in registry",
    "T1546.010": "appinit dlls",
    "T1190": "exploit public-facing application",
    "T1219": "remote access tools",
    "T1218": "signed binary proxy execution",
    "T1546.009": "appcert dlls",
    "T1547.004": "winlogon helper dll",
    "T1222": "file permissions modification",
    "T1056.004": "hooking",
    "T1542.001": "system firmware",
    "T1547.008": "lsass driver",
    "T1021.003": "distributed component object model",
    "T1218.003": "cmstp",
    "T1480": "execution guardrails",
    "T1546.015": "component object model hijacking",
    "T1546.008": "accessibility features",
    "T1555.001": "keychain",
    "T1218.005": "mshta",
    "T1550.003": "pass the ticket",
    "T1558.003": "kerberoasting",
    "T1201": "password policy discovery",
    "T1053.001": "local job scheduling",
    "T1021.006": "windows remote management",
    "T1197": "bits jobs",
    "T1213": "data from information repositories",
    "T1546.006": "lc_load_dylib addition",
    "T1562.003": "histcontrol",
    "T1006": "file system logical offsets",
    "T1218.009": "regsvcs/regasm",
    "T1212": "exploitation for credential access",
    "T1548.003": "sudo",
    "T1218.004": "installutil",
    "T1569.001": "launchctl",
    "T1546.004": ".bash_profile and .bashrc",
    "T1059.002": "applescript",
    "T1546.014": "emond",
    "T1218.002": "control panel items",
    "T1546.011": "application shimming",
    "T1001.001": "junk data",
    "T1001.002": "steganography",
    "T1001.003": "protocol impersonation",
    "T1002": "data compressed",
    "T1003.001": "lsass memory",
    "T1003.002": "security account manager",
    "T1003.003": "ntds",
    "T1003.004": "lsa secrets",
    "T1003.005": "cached domain credentials",
    "T1003.006": "dcsync",
    "T1003.007": "proc filesystem",
    "T1003.008": "/etc/passwd and /etc/shadow",
    "T1004": "winlogon helper dll",
    "T1005": "data from local system",
    "T1009": "binary padding",
    "T1011.001": "exfiltration over bluetooth",
    "T1011": "exfiltration over other network medium",
    "T1013": "port monitors",
    "T1014": "rootkit",
    "T1015": "accessibility features",
    "T1016.001": "internet connection discovery",
    "T1017": "application deployment software",
    "T1019": "system firmware",
    "T1020.001": "traffic duplication",
    "T1020": "automated exfiltration",
    "T1021.004": "ssh",
    "T1021.005": "vnc",
    "T1022": "data encrypted",
    "T1023": "shortcut modification",
    "T1024": "custom cryptographic protocol",
    "T1026": "multiband communication",
    "T1027.003": "steganography",
    "T1027.004": "compile after delivery",
    "T1027.005": "indicator removal from tools",
    "T1027.006": "html smuggling",
    "T1028": "windows remote management",
    "T1029": "scheduled transfer",
    "T1030": "data transfer size limits",
    "T1031": "modify existing service",
    "T1032": "standard cryptographic protocol",
    "T1034": "path interception",
    "T1035": "service execution",
    "T1036.001": "invalid code signature",
    "T1036.002": "right-to-left override",
    "T1036.003": "rename system utilities",
    "T1036.004": "masquerade task or service",
    "T1036.005": "match legitimate name or location",
    "T1036.006": "space after filename",
    "T1036.007": "double file extension",
    "T1037.001": "logon script (windows)",
    "T1037.002": "login hook",
    "T1037.003": "network logon script",
    "T1037.004": "rc scripts",
    "T1037.005": "startup items",
    "T1038": "dll search order hijacking",
    "T1039": "data from network shared drive",
    "T1040": "network sniffing",
    "T1042": "change default file association",
    "T1043": "commonly used port",
    "T1044": "file system permissions weakness",
    "T1045": "software packing",
    "T1048.001": "exfiltration over symmetric encrypted non-c2 protocol",
    "T1048.002": "exfiltration over asymmetric encrypted non-c2 protocol",
    "T1048.003": "exfiltration over unencrypted non-c2 protocol",
    "T1050": "new service",
    "T1051": "shared webroot",
    "T1052.001": "exfiltration over usb",
    "T1052": "exfiltration over physical medium",
    "T1053.002": "at",
    "T1053.003": "cron",
    "T1053.004": "launchd",
    "T1053.005": "scheduled task",
    "T1053.006": "systemd timers",
    "T1053.007": "container orchestration job",
    "T1054": "indicator blocking",
    "T1055.001": "dynamic-link library injection",
    "T1055.002": "portable executable injection",
    "T1055.003": "thread execution hijacking",
    "T1055.004": "asynchronous procedure call",
    "T1055.005": "thread local storage",
    "T1055.008": "ptrace system calls",
    "T1055.009": "proc memory",
    "T1055.011": "extra window memory injection",
    "T1055.013": "process doppelganging",
    "T1055.014": "vdso hijacking",
    "T1055.015": "listplanting",
    "T1056.001": "keylogging",
    "T1056.002": "gui input capture",
    "T1056.003": "web portal capture",
    "T1058": "service registry permissions weakness",
    "T1059.001": "powershell",
    "T1059.003": "windows command shell",
    "T1059.004": "unix shell",
    "T1059.005": "visual basic",
    "T1059.006": "python",
    "T1059.007": "javascript",
    "T1059.008": "network device cli",
    "T1060": "registry run keys / startup folder",
    "T1061": "graphical user interface",
    "T1062": "hypervisor",
    "T1063": "security software discovery",
    "T1064": "scripting",
    "T1065": "uncommonly used port",
    "T1066": "indicator removal from tools",
    "T1067": "bootkit",
    "T1069.001": "local groups",
    "T1069.002": "domain groups",
    "T1069.003": "cloud groups",
    "T1070.001": "clear windows event logs",
    "T1070.002": "clear linux or mac system logs",
    "T1070.003": "clear command history",
    "T1070.005": "network share connection removal",
    "T1071.001": "web protocols",
    "T1071.002": "file transfer protocols",
    "T1071.003": "mail protocols",
    "T1071.004": "dns",
    "T1072": "software deployment tools",
    "T1073": "dll side-loading",
    "T1074.001": "local data staging",
    "T1074.002": "remote data staging",
    "T1075": "pass the hash",
    "T1076": "remote desktop protocol",
    "T1077": "windows admin shares",
    "T1078.001": "default accounts",
    "T1078.002": "domain accounts",
    "T1078.003": "local accounts",
    "T1078.004": "cloud accounts",
    "T1079": "multilayer encryption",
    "T1080": "taint shared content",
    "T1081": "credentials in files",
    "T1084": "windows management instrumentation event subscription",
    "T1085": "rundll32",
    "T1086": "powershell",
    "T1087.001": "local account",
    "T1087.002": "domain account",
    "T1087.003": "email account",
    "T1087.004": "cloud account",
    "T1088": "bypass user account control",
    "T1089": "disabling security tools",
    "T1090.001": "internal proxy",
    "T1090.002": "external proxy",
    "T1090.003": "multi-hop proxy",
    "T1091": "replication through removable media",
    "T1092": "communication through removable media",
    "T1093": "process hollowing",
    "T1094": "custom command and control protocol",
    "T1095": "non-application layer protocol",
    "T1096": "ntfs file attributes",
    "T1097": "pass the ticket",
    "T1098.001": "additional cloud credentials",
    "T1098.002": "additional email delegate permissions",
    "T1098.003": "additional cloud roles",
    "T1098.004": "ssh authorized keys",
    "T1098.005": "device registration",
    "T1098": "account manipulation",
    "T1099": "timestomp",
    "T1100": "web shell",
    "T1101": "security support provider",
    "T1102.001": "dead drop resolver",
    "T1102.002": "bidirectional communication",
    "T1102.003": "one-way communication",
    "T1103": "appinit dlls",
    "T1104": "multi-stage channels",
    "T1107": "file deletion",
    "T1108": "redundant access",
    "T1109": "component firmware",
    "T1110.001": "password guessing",
    "T1110.002": "password cracking",
    "T1110.003": "password spraying",
    "T1110.004": "credential stuffing",
    "T1111": "multi-factor authentication interception",
    "T1114.001": "local email collection",
    "T1114.002": "remote email collection",
    "T1114.003": "email forwarding rule",
    "T1116": "code signing",
    "T1117": "regsvr32",
    "T1118": "installutil",
    "T1119": "automated collection",
    "T1121": "regsvcs/regasm",
    "T1122": "component object model hijacking",
    "T1126": "network share connection removal",
    "T1127.001": "msbuild",
    "T1127": "trusted developer utilities proxy execution",
    "T1128": "netsh helper dll",
    "T1130": "install root certificate",
    "T1131": "authentication package",
    "T1132.001": "standard encoding",
    "T1132.002": "non-standard encoding",
    "T1134.001": "token impersonation/theft",
    "T1134.002": "create process with token",
    "T1134.003": "make and impersonate token",
    "T1134.004": "parent pid spoofing",
    "T1136.001": "local account",
    "T1136.002": "domain account",
    "T1136.003": "cloud account",
    "T1137.001": "office template macros",
    "T1137.002": "office test",
    "T1137.003": "outlook forms",
    "T1137.004": "outlook home page",
    "T1137.005": "outlook rules",
    "T1137.006": "add-ins",
    "T1138": "application shimming",
    "T1139": "bash history",
    "T1141": "input prompt",
    "T1142": "keychain",
    "T1143": "hidden window",
    "T1144": "gatekeeper bypass",
    "T1145": "private keys",
    "T1146": "clear command history",
    "T1147": "hidden users",
    "T1148": "histcontrol",
    "T1149": "lc_main hijacking",
    "T1150": "plist modification",
    "T1151": "space after filename",
    "T1152": "launchctl",
    "T1153": "source",
    "T1154": "trap",
    "T1155": "applescript",
    "T1156": "malicious shell modification",
    "T1157": "dylib hijacking",
    "T1158": "hidden files and directories",
    "T1159": "launch agent",
    "T1160": "launch daemon",
    "T1161": "lc_load_dylib addition",
    "T1162": "login item",
    "T1163": "rc.common",
    "T1164": "re-opened applications",
    "T1165": "startup items",
    "T1166": "setuid and setgid",
    "T1167": "securityd memory",
    "T1168": "local job scheduling",
    "T1169": "sudo",
    "T1170": "mshta",
    "T1171": "llmnr/nbt-ns poisoning and relay",
    "T1172": "domain fronting",
    "T1173": "dynamic data exchange",
    "T1174": "password filter dll",
    "T1175": "component object model and distributed com",
    "T1176": "browser extensions",
    "T1177": "lsass driver",
    "T1178": "sid-history injection",
    "T1179": "hooking",
    "T1180": "screensaver",
    "T1181": "extra window memory injection",
    "T1182": "appcert dlls",
    "T1183": "image file execution options injection",
    "T1184": "ssh hijacking",
    "T1186": "process doppelganging",
    "T1187": "forced authentication",
    "T1188": "multi-hop proxy",
    "T1191": "cmstp",
    "T1192": "spearphishing link",
    "T1193": "spearphishing attachment",
    "T1194": "spearphishing via service",
    "T1195.001": "compromise software dependencies and development tools",
    "T1195.002": "compromise software supply chain",
    "T1195.003": "compromise hardware supply chain",
    "T1195": "supply chain compromise",
    "T1196": "control panel items",
    "T1198": "sip and trust provider hijacking",
    "T1199": "trusted relationship",
    "T1200": "hardware additions",
    "T1202": "indirect command execution",
    "T1204.001": "malicious link",
    "T1204.002": "malicious file",
    "T1204.003": "malicious image",
    "T1205.001": "port knocking",
    "T1205": "traffic signaling",
    "T1206": "sudo caching",
    "T1207": "rogue domain controller",
    "T1208": "kerberoasting",
    "T1209": "time providers",
    "T1211": "exploitation for defense evasion",
    "T1213.001": "confluence",
    "T1213.002": "sharepoint",
    "T1213.003": "code repositories",
    "T1214": "credentials in registry",
    "T1215": "kernel modules and extensions",
    "T1216.001": "pubprn",
    "T1216": "system script proxy execution",
    "T1217": "browser bookmark discovery",
    "T1218.001": "compiled html file",
    "T1218.007": "msiexec",
    "T1218.008": "odbcconf",
    "T1218.012": "verclsid",
    "T1218.013": "mavinject",
    "T1218.014": "mmc",
    "T1220": "xsl script processing",
    "T1222.001": "windows file and directory permissions modification",
    "T1222.002": "linux and mac file and directory permissions modification",
    "T1223": "compiled html file",
    "T1480.001": "environmental keying",
    "T1483": "domain generation algorithms",
    "T1484.001": "group policy modification",
    "T1484.002": "domain trust modification",
    "T1484": "domain policy modification",
    "T1487": "disk structure wipe",
    "T1488": "disk content wipe",
    "T1491.001": "internal defacement",
    "T1491.002": "external defacement",
    "T1491": "defacement",
    "T1492": "stored data manipulation",
    "T1493": "transmitted data manipulation",
    "T1494": "runtime data manipulation",
    "T1495": "firmware corruption",
    "T1496": "resource hijacking",
    "T1497.002": "user activity based checks",
    "T1497.003": "time based evasion",
    "T1497": "virtualization/sandbox evasion",
    "T1498.001": "direct network flood",
    "T1498.002": "reflection amplification",
    "T1498": "network denial of service",
    "T1499.001": "os exhaustion flood",
    "T1499.002": "service exhaustion flood",
    "T1499.003": "application exhaustion flood",
    "T1499.004": "application or system exploitation",
    "T1499": "endpoint denial of service",
    "T1500": "compile after delivery",
    "T1501": "systemd service",
    "T1502": "parent pid spoofing",
    "T1503": "credentials from web browsers",
    "T1504": "powershell profile",
    "T1505.001": "sql stored procedures",
    "T1505.002": "transport agent",
    "T1505.004": "iis components",
    "T1505.005": "terminal services dll",
    "T1505": "server software component",
    "T1506": "web session cookie",
    "T1514": "elevated execution with prompt",
    "T1518": "software discovery",
    "T1519": "emond",
    "T1522": "cloud instance metadata api",
    "T1525": "implant internal image",
    "T1526": "cloud service discovery",
    "T1527": "application access token",
    "T1528": "steal application access token",
    "T1529": "system shutdown/reboot",
    "T1530": "data from cloud storage object",
    "T1531": "account access removal",
    "T1534": "internal spearphishing",
    "T1535": "unused/unsupported cloud regions",
    "T1536": "revert cloud instance",
    "T1537": "transfer data to cloud account",
    "T1538": "cloud service dashboard",
    "T1539": "steal web session cookie",
    "T1542.002": "component firmware",
    "T1542.004": "rommonkit",
    "T1542.005": "tftp boot",
    "T1542": "pre-os boot",
    "T1543.002": "systemd service",
    "T1543.003": "windows service",
    "T1543.004": "launch daemon",
    "T1546.001": "change default file association",
    "T1546.002": "screensaver",
    "T1546.003": "windows management instrumentation event subscription",
    "T1546.005": "trap",
    "T1546.007": "netsh helper dll",
    "T1546.012": "image file execution options injection",
    "T1546": "event triggered execution",
    "T1547.002": "authentication package",
    "T1547.003": "time providers",
    "T1547.005": "security support provider",
    "T1547.006": "kernel modules and extensions",
    "T1547.007": "re-opened applications",
    "T1547.010": "port monitors",
    "T1547.011": "plist modification",
    "T1547.012": "print processors",
    "T1547.013": "xdg autostart entries",
    "T1547.014": "active setup",
    "T1547.015": "login items",
    "T1547": "boot or logon autostart execution",
    "T1548.001": "setuid and setgid",
    "T1548.004": "elevated execution with prompt",
    "T1548": "abuse elevation control mechanism",
    "T1550.001": "application access token",
    "T1550.004": "web session cookie",
    "T1550": "use alternate authentication material",
    "T1552.003": "bash history",
    "T1552.004": "private keys",
    "T1552.005": "cloud instance metadata api",
    "T1552.006": "group policy preferences",
    "T1552.007": "container api",
    "T1552": "unsecured credentials",
    "T1553.001": "gatekeeper bypass",
    "T1553.003": "sip and trust provider hijacking",
    "T1553.004": "install root certificate",
    "T1553.005": "mark-of-the-web bypass",
    "T1553.006": "code signing policy modification",
    "T1553": "subvert trust controls",
    "T1554": "compromise client software binary",
    "T1555.002": "securityd memory",
    "T1555.003": "credentials from web browsers",
    "T1555.004": "windows credential manager",
    "T1555.005": "password managers",
    "T1555": "credentials from password stores",
    "T1556.001": "domain controller authentication",
    "T1556.002": "password filter dll",
    "T1556.003": "pluggable authentication modules",
    "T1556.004": "network device authentication",
    "T1556.005": "reversible encryption",
    "T1556": "modify authentication process",
    "T1557.002": "arp cache poisoning",
    "T1557.003": "dhcp spoofing",
    "T1557": "adversary-in-the-middle",
    "T1558.001": "golden ticket",
    "T1558.002": "silver ticket",
    "T1558.004": "as-rep roasting",
    "T1558": "steal or forge kerberos tickets",
    "T1559.001": "component object model",
    "T1559.003": "xpc services",
    "T1559": "inter-process communication",
    "T1560.001": "archive via utility",
    "T1560.002": "archive via library",
    "T1560.003": "archive via custom method",
    "T1561.001": "disk content wipe",
    "T1561": "disk wipe",
    "T1562.002": "disable windows event logging",
    "T1562.004": "disable or modify system firewall",
    "T1562.006": "indicator blocking",
    "T1562.007": "disable or modify cloud firewall",
    "T1562.008": "disable cloud logs",
    "T1562.009": "safe mode boot",
    "T1562.010": "downgrade attack",
    "T1562": "impair defenses",
    "T1563.001": "ssh hijacking",
    "T1563.002": "rdp hijacking",
    "T1563": "remote service session hijacking",
    "T1564.002": "hidden users",
    "T1564.003": "hidden window",
    "T1564.004": "ntfs file attributes",
    "T1564.005": "hidden file system",
    "T1564.006": "run virtual instance",
    "T1564.007": "vba stomping",
    "T1564.008": "email hiding rules",
    "T1564.009": "resource forking",
    "T1564.010": "process argument spoofing",
    "T1564": "hide artifacts",
    "T1565.001": "stored data manipulation",
    "T1565.002": "transmitted data manipulation",
    "T1565.003": "runtime data manipulation",
    "T1565": "data manipulation",
    "T1566": "phishing",
    "T1567.001": "exfiltration to code repository",
    "T1567.002": "exfiltration to cloud storage",
    "T1567": "exfiltration over web service",
    "T1568.001": "fast flux dns",
    "T1568.002": "domain generation algorithms",
    "T1568.003": "dns calculation",
    "T1568": "dynamic resolution",
    "T1569": "system services",
    "T1570": "lateral tool transfer",
    "T1572": "protocol tunneling",
    "T1573.001": "symmetric cryptography",
    "T1573.002": "asymmetric cryptography",
    "T1574.004": "dylib hijacking",
    "T1574.005": "executable installer file permissions weakness",
    "T1574.006": "dynamic linker hijacking",
    "T1574.007": "path interception by path environment variable",
    "T1574.008": "path interception by search order hijacking",
    "T1574.009": "path interception by unquoted path",
    "T1574.010": "services file permissions weakness",
    "T1574.011": "services registry permissions weakness",
    "T1574.012": "cor_profiler",
    "T1574.013": "kernelcallbacktable",
    "T1574": "hijack execution flow",
    "T1578.001": "create snapshot",
    "T1578.002": "create cloud instance",
    "T1578.003": "delete cloud instance",
    "T1578.004": "revert cloud instance",
    "T1578": "modify cloud compute infrastructure",
    "T1580": "cloud infrastructure discovery",
    "T1583.001": "domains",
    "T1583.002": "dns server",
    "T1583.003": "virtual private server",
    "T1583.004": "server",
    "T1583.005": "botnet",
    "T1583.006": "web services",
    "T1583": "acquire infrastructure",
    "T1584.001": "domains",
    "T1584.002": "dns server",
    "T1584.003": "virtual private server",
    "T1584.004": "server",
    "T1584.005": "botnet",
    "T1584.006": "web services",
    "T1584": "compromise infrastructure",
    "T1585.001": "social media accounts",
    "T1585.002": "email accounts",
    "T1585": "establish accounts",
    "T1586.001": "social media accounts",
    "T1586.002": "email accounts",
    "T1586": "compromise accounts",
    "T1587.001": "malware",
    "T1587.002": "code signing certificates",
    "T1587.003": "digital certificates",
    "T1587.004": "exploits",
    "T1587": "develop capabilities",
    "T1588.001": "malware",
    "T1588.002": "tool",
    "T1588.003": "code signing certificates",
    "T1588.004": "digital certificates",
    "T1588.005": "exploits",
    "T1588.006": "vulnerabilities",
    "T1588": "obtain capabilities",
    "T1589.001": "credentials",
    "T1589.002": "email addresses",
    "T1589.003": "employee names",
    "T1589": "gather victim identity information",
    "T1590.001": "domain properties",
    "T1590.002": "dns",
    "T1590.003": "network trust dependencies",
    "T1590.004": "network topology",
    "T1590.005": "ip addresses",
    "T1590.006": "network security appliances",
    "T1590": "gather victim network information",
    "T1591.001": "determine physical locations",
    "T1591.002": "business relationships",
    "T1591.003": "identify business tempo",
    "T1591.004": "identify roles",
    "T1591": "gather victim org information",
    "T1592.001": "hardware",
    "T1592.002": "software",
    "T1592.003": "firmware",
    "T1592.004": "client configurations",
    "T1592": "gather victim host information",
    "T1593.001": "social media",
    "T1593.002": "search engines",
    "T1593": "search open websites/domains",
    "T1594": "search victim-owned websites",
    "T1595.001": "scanning ip blocks",
    "T1595.002": "vulnerability scanning",
    "T1595.003": "wordlist scanning",
    "T1595": "active scanning",
    "T1596.001": "dns/passive dns",
    "T1596.002": "whois",
    "T1596.003": "digital certificates",
    "T1596.004": "cdns",
    "T1596.005": "scan databases",
    "T1596": "search open technical databases",
    "T1597.001": "threat intel vendors",
    "T1597.002": "purchase technical data",
    "T1597": "search closed sources",
    "T1598.001": "spearphishing service",
    "T1598.002": "spearphishing attachment",
    "T1598.003": "spearphishing link",
    "T1598": "phishing for information",
    "T1599.001": "network address translation traversal",
    "T1599": "network boundary bridging",
    "T1600.001": "reduce key space",
    "T1600.002": "disable crypto hardware",
    "T1600": "weaken encryption",
    "T1601.001": "patch system image",
    "T1601.002": "downgrade system image",
    "T1601": "modify system image",
    "T1602.001": "snmp (mib dump)",
    "T1602.002": "network device configuration dump",
    "T1602": "data from configuration repository",
    "T1606.001": "web cookies",
    "T1606.002": "saml tokens",
    "T1606": "forge web credentials",
    "T1608.001": "upload malware",
    "T1608.002": "upload tool",
    "T1608.003": "install digital certificate",
    "T1608.004": "drive-by target",
    "T1608.005": "link target",
    "T1608": "stage capabilities",
    "T1609": "container administration command",
    "T1610": "deploy container",
    "T1611": "escape to host",
    "T1612": "build image on host",
    "T1613": "container and resource discovery",
    "T1614.001": "system language discovery",
    "T1614": "system location discovery",
    "T1615": "group policy discovery",
    "T1619": "cloud storage object discovery",
    "T1620": "reflective code loading",
    "T1621": "multi-factor authentication request generation",
    "T1622": "debugger evasion",
    "T1647": "plist file modification",
    "T1059": "command-line interface"
}
    
ATTACK_LOOKUP = dict([(value, key) for key, value in ATTACK_LOOKUP.items()])


class TrainingData(object):
    def __init__(self):
        self.mappings = {}  # Mapping is sentence text plus a list of Attack IDs

    def add_mapping(self, sentence_text, attack_id=None):
        mappings = self.mappings.get(sentence_text, [])  # Get mappings or empty list

        if attack_id:  # If attack_id is specified, add it to the list
            if attack_id not in mappings:
                mappings.append(attack_id)

        self.mappings[sentence_text] = mappings  # Put the mapping list back in

    def to_report_export_serializer_json(self):
        """Creates a dict that can be used to create
        a serializers.ReportExportSerializer instance
        """
        utc_now = datetime.utcnow().isoformat() + "Z"
        res_json = {
            "name": "Bootstrap Training Data",
            "text": "There is no text for this report. These sentences were mapped by human analysts.",
            "ml_model": "humans",
            "created_on": utc_now,
            "updated_on": utc_now,
            "sentences": [],
        }

        order = 0
        for sentence_text, mappings in self.mappings.items():
            if len(sentence_text.strip()) == 0:  # Skip empty sentences
                continue
            if sentence_text.startswith("- "):
                sentence = {
                    "text": sentence_text,
                    "order": order,
                    "disposition": "accept",
                    "mappings": [],
                }

                order += 1

                for mapping in mappings:
                    mapping = {"attack_id": mapping, "confidence": "100.0"}
                    sentence["mappings"].append(mapping)
                res_json["sentences"].append(sentence)
            else:
                sentence = {
                    "text": sentence_text,
                    "order": order,
                    "disposition": "accept",
                    "mappings": [],
                }

                order += 1

                for mapping in mappings:
                    mapping = {"attack_id": mapping, "confidence": "40.0"}
                    sentence["mappings"].append(mapping)
                res_json["sentences"].append(sentence)

        return res_json


def get_attack_id(description):
    """Given a description, get the ATTACK ID. Raises IndexError if the retrieval fails."""
    lower_description = description.lower()
    attack_id = ATTACK_LOOKUP[lower_description]
    return attack_id


def main():
    with open("data/training/archive/all_analyzed_reports.json") as f:
        all_analyzed_reports = json.load(f)

    with open("data/training/archive/negative_data.json") as f:
        negative_data = json.load(f)

    training_data = TrainingData()

    # Add the positives
    for key, value in all_analyzed_reports.items():
        if key.endswith("-multi"):  # It's a multi-mapping, value is a dictionary
            for sentence in value[
                "sentances"
            ]:  # Sentences is misspelled in the source data
                map(
                    partial(training_data.add_mapping, sentence),
                    [ATTACK_LOOKUP[name.lower()] for name in value["technique_names"]],
                )
        else:  # It's a single-mapping, value is a list of sentences
            technique_id = get_attack_id(key)
            for sentence in value:
                training_data.add_mapping(sentence, technique_id)

    # Add the negatives
    for sentence in negative_data:
        training_data.add_mapping(sentence, None)
    res_json = training_data.to_report_export_serializer_json()

    res = ReportExportSerializer(data=res_json)
    res.is_valid(raise_exception=True)

    with open(outfile, "w") as f:
        json.dump(res.initial_data, f, indent=4)

    logger.info("Wrote data to %s" % outfile)


if __name__ == "__main__":
    main()
